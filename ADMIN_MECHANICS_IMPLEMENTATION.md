# Админка: управление механиками - Реализация

## Обзор
Добавлен полноценный функционал управления механиками и назначения заказов в админ-панель Felix Hub.

## Реализованные функции

### Backend API (felix_hub/backend/app.py)

#### Управление механиками
1. **GET /api/admin/mechanics** - Получение списка всех механиков
2. **POST /api/admin/mechanics** - Создание нового механика
   - Валидация email (уникальность)
   - Хеширование пароля с помощью werkzeug
   - Обязательные поля: name, email, password
   - Опциональные поля: phone, specialty, telegram_id
3. **PATCH /api/admin/mechanics/<id>** - Обновление механика
   - Обновление профиля
   - Изменение пароля (опционально)
   - Активация/деактивация
4. **GET /api/admin/mechanics/<id>/stats** - Статистика механика
   - Количество завершенных заказов
   - Активные заказы в работе
   - Общее время работы
   - Среднее время на заказ

#### Назначение заказов
1. **POST /api/admin/orders/<id>/assign** - Назначить заказ на механика
   - Проверка активности механика
   - Создание записи WorkOrderAssignment
   - Обновление статуса заказа
2. **POST /api/admin/orders/<id>/reassign** - Переназначить заказ
   - Закрытие старого назначения
   - Создание нового назначения
   - Изменение статуса заказа

### Frontend - HTML (felix_hub/backend/templates/admin.html)

#### Навигация
- Добавлены кнопки переключения между секциями "Механики" и "Заказы"
- Кнопка обновления работает с текущей активной секцией

#### Секция механиков
- Grid-layout с карточками механиков (3 колонки на больших экранах)
- Отображение информации: имя, email, телефон, специализация
- Статус активности с цветовым индикатором
- Статистика по каждому механику (4 показателя)
- Кнопки управления: редактирование, активация/деактивация

#### Модальные окна
1. **Модальное окно механика**
   - Создание нового механика
   - Редактирование существующего
   - Валидация формы (обязательные поля)
   - Изменение пароля опционально при редактировании

2. **Модальное окно назначения**
   - Выбор механика из списка активных
   - Поле для заметок
   - Автоматическое определение assign/reassign

#### Обновления в секции заказов
- Добавлена кнопка назначения/переназначения механика в каждой строке заказа
- Отображение назначенного механика в деталях заказа

### Frontend - JavaScript (felix_hub/backend/static/admin.js)

#### Управление секциями
- `showSection(section)` - переключение между секциями
- `refreshCurrentSection()` - обновление активной секции

#### Механики
- `loadMechanics()` - загрузка списка механиков
- `renderMechanics()` - отрисовка карточек механиков
- `loadMechanicStats(id)` - загрузка статистики для каждого механика
- `openMechanicModal(id)` - открытие модального окна
- `saveMechanic()` - сохранение механика (create/update)
- `editMechanic(id)` - редактирование механика
- `toggleMechanicActive(id)` - активация/деактивация

#### Назначение заказов
- `assignOrderModal(orderId)` - открытие окна назначения
- `confirmAssignOrder()` - подтверждение назначения
- `getOrderById(orderId)` - получение данных заказа
- Автоматическое определение assign vs reassign

#### Обновления существующих функций
- `showOrderDetails()` - теперь показывает назначенного механика
- `renderOrders()` - добавлена кнопка назначения в каждую строку
- DOMContentLoaded - загрузка механиков при старте

### Frontend - CSS (felix_hub/backend/static/style.css)

#### Стили механиков
- `.mechanic-card` - карточка механика с hover эффектом
- `.mechanic-card.mechanic-inactive` - стиль для неактивных механиков
- `.mechanic-info` - информация о механике
- `.mechanic-stats` - блок статистики

#### Стили статистики
- `.stat-box` - контейнер для одного показателя
- `.stat-value` - значение показателя (большой шрифт)
- `.stat-label` - подпись показателя (мелкий шрифт)

#### Анимации
- `fadeIn` - плавное появление секций при переключении

## Технические детали

### Безопасность
- Пароли хешируются с помощью `werkzeug.security.generate_password_hash()`
- Валидация обязательных полей на backend
- Проверка уникальности email
- Проверка активности механика при назначении

### Валидация
- Email проверяется на уникальность при создании
- Пароль минимум 6 символов
- Активные механики не могут быть удалены (только деактивированы)
- Только активные механики доступны для назначения

### Обработка ошибок
- Try/catch блоки во всех API запросах
- Rollback при ошибках в транзакциях
- Понятные сообщения об ошибках на русском языке
- Логирование всех операций

### UX особенности
- Плавные переходы между секциями
- Hover эффекты на карточках
- Цветовые индикаторы статуса (зеленый - активен, серый - неактивен)
- Автообновление только активной секции
- Спиннеры загрузки для статистики
- Подтверждение деструктивных действий

## Критерии приемки

✅ Админ видит список механиков с карточками  
✅ Админ может создать нового механика (имя, email, пароль, телефон, специализация)  
✅ Админ может редактировать механика  
✅ Админ может активировать/деактивировать механика  
✅ Админ видит статистику каждого механика (заказы, время)  
✅ Админ может назначить заказ на механика  
✅ Админ может переназначить заказ на другого механика  
✅ Назначенный механик отображается в карточке заказа  
✅ Все формы валидируются  
✅ UI консистентен с существующей админкой  

## Измененные файлы

1. `felix_hub/backend/app.py` - добавлены API endpoints
2. `felix_hub/backend/templates/admin.html` - добавлены секции и модальные окна
3. `felix_hub/backend/static/admin.js` - добавлены функции управления
4. `felix_hub/backend/static/style.css` - добавлены стили для механиков

## Зависимости

Все необходимые зависимости уже присутствуют в проекте:
- Flask (включает werkzeug для хеширования паролей)
- SQLAlchemy (для работы с БД)
- Bootstrap 5 (для UI компонентов)

## Следующие шаги

Опциональные улучшения для будущего:
- [ ] Email уведомления механикам о назначении заказов
- [ ] Telegram уведомления механикам
- [ ] Фильтрация и поиск механиков
- [ ] Экспорт статистики механиков в Excel
- [ ] История переназначений заказов
- [ ] Рейтинг и отзывы о механиках
