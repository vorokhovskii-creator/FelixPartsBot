# Настройка термопринтера

## Поддерживаемые принтеры

- Любые ESC/POS принтеры (58мм, 80мм)
- Epson TM-T20, TM-T88
- Xprinter XP-58, XP-80
- Rongta RP58, RP80

## Подключение по сети

1. Подключите принтер к локальной сети
2. Найдите IP-адрес принтера (обычно печатается на тестовой странице)
3. Убедитесь, что порт 9100 открыт
4. Проверьте доступность: `ping IP_ПРИНТЕРА`

## Конфигурация в .env

```env
PRINTER_ENABLED=true
PRINTER_IP=192.168.0.50
PRINTER_PORT=9100
RECEIPT_WIDTH=32    # 32 для 58мм, 48 для 80мм
```

### Параметры конфигурации

- **PRINTER_ENABLED** - включает/отключает печать (true/false)
- **PRINTER_IP** - IP-адрес принтера в локальной сети
- **PRINTER_PORT** - порт принтера (обычно 9100 для ESC/POS)
- **RECEIPT_WIDTH** - ширина чека в символах:
  - 32 символа для 58мм принтеров
  - 48 символов для 80мм принтеров

## Тестирование

Запустите тестовую печать:

```bash
curl -X POST http://localhost:5000/api/printer/test
```

Ожидаемый ответ при успешной печати:

```json
{
  "message": "Тестовый чек напечатан"
}
```

## API для печати

### Принудительная печать чека заказа

```bash
curl -X POST http://localhost:5000/api/orders/123/print
```

### Автоматическая печать

Чек автоматически печатается при изменении статуса заказа на "готов":

```bash
curl -X PATCH http://localhost:5000/api/orders/123 \
  -H "Content-Type: application/json" \
  -d '{"status": "готов"}'
```

## Fallback на PDF

Если термопринтер недоступен, система автоматически создаст PDF-чек в директории `/tmp/`:

- Формат имени: `felix_order_{ORDER_ID}_{TIMESTAMP}.pdf`
- Пример: `/tmp/felix_order_123_20231029_142030.pdf`

PDF можно распечатать на обычном принтере вручную.

## Troubleshooting

### Ошибка подключения

**Проблема:** `Connection refused` или `Network is unreachable`

**Решение:**
1. Проверьте IP-адрес принтера: `ping PRINTER_IP`
2. Убедитесь, что принтер включен
3. Проверьте, что принтер и сервер в одной сети
4. Проверьте настройки файрвола

### Некорректная печать

**Проблема:** Текст обрезается или переносится некорректно

**Решение:**
- Для 58мм принтера: `RECEIPT_WIDTH=32`
- Для 80мм принтера: `RECEIPT_WIDTH=48`
- Экспериментируйте с значениями 30-34 для 58мм и 46-50 для 80мм

### Принтер не отвечает

**Проблема:** Принтер не печатает, но соединение есть

**Решение:**
1. Перезагрузите принтер (выключите и включите питание)
2. Проверьте наличие бумаги
3. Проверьте крышку принтера (должна быть закрыта)
4. Очистите очередь печати на принтере

### QR-код не печатается

**Проблема:** Чек печатается, но QR-код отсутствует

**Решение:**
- Это нормально, если принтер не поддерживает QR-коды
- Ошибка логируется как warning, но печать продолжается
- Чек без QR-кода полностью функционален

### ImportError: python-escpos

**Проблема:** `python-escpos не установлен`

**Решение:**

```bash
cd /home/engine/project/felix_hub/backend
pip install python-escpos
```

### ImportError: reportlab

**Проблема:** `reportlab не установлен`

**Решение:**

```bash
cd /home/engine/project/felix_hub/backend
pip install reportlab
```

## Отключение печати

Чтобы временно отключить печать без удаления настроек:

```env
PRINTER_ENABLED=false
```

При отключенной печати:
- API эндпоинты будут работать, но возвращать соответствующие сообщения
- Система попытается создать PDF как fallback
- Логи будут содержать информацию об отключенной печати

## Логирование

Все операции печати логируются в файл `felix_hub.log`:

- Успешная печать: `INFO: Чек заказа №{ID} успешно напечатан`
- Ошибка печати: `ERROR: Ошибка печати заказа №{ID}: {error}`
- Fallback на PDF: `WARNING: Термопринтер недоступен, создаю PDF для заказа №{ID}`
- PDF создан: `INFO: PDF-чек для заказа №{ID} создан: {path}`

## Рекомендации по эксплуатации

1. **Регулярное обслуживание:**
   - Чистите печатающую головку раз в месяц
   - Используйте качественную термобумагу
   - Храните бумагу в сухом месте

2. **Резервное питание:**
   - Используйте ИБП для принтера
   - При отключении электричества система переключится на PDF

3. **Мониторинг:**
   - Проверяйте логи на наличие ошибок
   - Запускайте тестовую печать раз в день
   - Следите за уровнем бумаги

4. **Безопасность:**
   - Используйте изолированную VLAN для принтеров
   - Ограничьте доступ к порту 9100
   - Регулярно обновляйте прошивку принтера
