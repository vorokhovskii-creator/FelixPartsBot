# –°–∏—Å—Ç–µ–º–∞ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–µ—Ö–∞–Ω–∏–∫–∞–º

## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–µ—Ö–∞–Ω–∏–∫–∞–º —á–µ—Ä–µ–∑ Telegram, –∫–æ–≥–¥–∞ –∏—Ö –∑–∞–∫–∞–∑—ã –≥–æ—Ç–æ–≤—ã –∫ –≤—ã–¥–∞—á–µ.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –§–∞–π–ª—ã

1. **`utils/notifier.py`** - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. **`app.py`** - –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **`test_notifier.py`** - —Ç–µ—Å—Ç—ã –¥–ª—è –º–æ–¥—É–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥—É–ª—è notifier.py

#### `send_telegram_notification(chat_id, message, parse_mode='HTML')`
–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram Bot API.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `chat_id` - Telegram ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `message` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `parse_mode` - —Ä–µ–∂–∏–º –ø–∞—Ä—Å–∏–Ω–≥–∞ (HTML, Markdown)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `bool` - True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Timeout 5 —Å–µ–∫—É–Ω–¥
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ (—Ç–∞–π–º–∞—É—Ç, —Å–µ—Ç—å, API)
- Graceful degradation - –Ω–µ –ø–∞–¥–∞–µ—Ç –µ—Å–ª–∏ BOT_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

#### `notify_order_ready(order)`
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∫—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞.

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{id} –≥–æ—Ç–æ–≤!

üì¶ –î–µ—Ç–∞–ª–∏:
  ‚Ä¢ –ü–µ—Ä–µ–¥–Ω–∏–µ –∫–æ–ª–æ–¥–∫–∏
  ‚Ä¢ –î–∏—Å–∫–∏ –ø–µ—Ä–µ–¥–Ω–∏–µ

üöó VIN: 4T1BE32K
üìÖ –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞: 29.10.2025 15:30

–ó–∞–±–µ—Ä–∏ –∑–∞–ø—á–∞—Å—Ç–∏ —É –∫–ª–∞–¥–æ–≤—â–∏–∫–∞! üîß
```

#### `notify_order_status_changed(order, old_status, new_status)`
–£–≤–µ–¥–æ–º–ª—è–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞.

**–°—Ç–∞—Ç—É—Å—ã —Å —ç–º–æ–¥–∑–∏:**
- `–Ω–æ–≤—ã–π` - üÜï
- `–≤ —Ä–∞–±–æ—Ç–µ` - ‚è≥
- `–≥–æ—Ç–æ–≤` - ‚úÖ
- `–≤—ã–¥–∞–Ω` - üì¶

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ "–≥–æ—Ç–æ–≤" –∏ "–≤—ã–¥–∞–Ω"

#### `send_order_delayed_notification(order)`
–£–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –∑–∞–¥–µ—Ä–∂–∫–µ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞.

#### `send_bulk_notification(telegram_ids, message)`
–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `dict` —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π `{'success': int, 'failed': int}`

#### `send_with_retry(chat_id, message, max_retries=3)`
–û—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å app.py

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ update_order endpoint

```python
@app.route('/api/orders/<int:order_id>', methods=['PATCH'])
def update_order(order_id):
    # ...
    old_status = order.status
    
    if 'status' in data:
        new_status = data['status']
        order.status = new_status
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        if new_status == '–≥–æ—Ç–æ–≤':
            notify_order_ready(order)
        elif new_status in ['–≤ —Ä–∞–±–æ—Ç–µ', '–≤—ã–¥–∞–Ω']:
            notify_order_status_changed(order, old_status, new_status)
    # ...
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª:

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('felix_hub.log'),
        logging.StreamHandler()
    ]
)
```

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
- –û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å –¥–µ—Ç–∞–ª—è–º–∏)
- –¢–∞–π–º–∞—É—Ç—ã
- –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª `.env`:

```env
BOT_TOKEN=your_telegram_bot_token_here
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `.env.example`

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ BOT_TOKEN** - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
2. **–¢–∞–π–º–∞—É—Ç—ã** - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è False
3. **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏** - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è False
4. **–û—à–∏–±–∫–∏ Telegram API** - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –∫–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è False

API –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
python test_api.py
python test_comprehensive.py
python test_filters.py
python test_notifier.py
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ ‚úÖ:
- –ë–∞–∑–æ–≤—ã–π API —Ç–µ—Å—Ç (test_api.py)
- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç (test_comprehensive.py)
- –¢–µ—Å—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (test_filters.py)
- –¢–µ—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (test_notifier.py)

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

‚úÖ –ú–æ–¥—É–ª—å notifier.py —Å–æ–∑–¥–∞–Ω —Å–æ –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏  
‚úÖ send_telegram_notification() –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Bot API  
‚úÖ notify_order_ready() —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏  
‚úÖ notify_order_status_changed() —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞  
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å app.py: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–≥–æ—Ç–æ–≤"  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Ç–∞–π–º–∞—É—Ç—ã, —Å–±–æ–∏ API)  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫  
‚úÖ BOT_TOKEN —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ .env  
‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –ø–∞–¥–∞–µ—Ç)  
‚úÖ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —ç–º–æ–¥–∑–∏  

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
from utils.notifier import send_telegram_notification

success = send_telegram_notification(
    chat_id='123456789',
    message='<b>–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</b> ‚úÖ'
)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞

```python
from utils.notifier import notify_order_ready

order = Order.query.get(order_id)
notify_order_ready(order)
```

### –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞

```python
from utils.notifier import send_bulk_notification

telegram_ids = ['123', '456', '789']
results = send_bulk_notification(
    telegram_ids,
    'üîß <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –°–∫–ª–∞–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–º—É –≥—Ä–∞—Ñ–∏–∫—É.'
)
print(f"–£—Å–ø–µ—à–Ω–æ: {results['success']}, –û—à–∏–±–æ–∫: {results['failed']}")
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

```python
from utils.notifier import send_with_retry

success = send_with_retry(
    chat_id='123456789',
    message='–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
    max_retries=3
)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- **API URL:** `https://api.telegram.org/bot{BOT_TOKEN}/sendMessage`
- **Timeout:** 5 —Å–µ–∫—É–Ω–¥
- **Parse mode:** HTML (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **Retry logic:** –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (2^attempt —Å–µ–∫—É–Ω–¥)
- **Logging level:** INFO
- **Log file:** felix_hub.log

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. BOT_TOKEN —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ .env (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ git)
2. .env –¥–æ–±–∞–≤–ª–µ–Ω –≤ .gitignore
3. –í–∞–ª–∏–¥–∞—Ü–∏—è chat_id –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
4. Timeout –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏–π
5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `felix_hub.log`:

```
2025-10-29 20:04:11 - utils.notifier - INFO - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 123456789
2025-10-29 20:04:11 - utils.notifier - INFO - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ ‚Ññ5 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
2025-10-29 20:04:11 - utils.notifier - ERROR - –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 987654321
```
